<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#080C14">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ë§ˆì¼“ë ˆì´ë”</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#080C14;--bg2:#0D1220;--bg3:#111827;
  --sf:rgba(255,255,255,.04);--bd:rgba(255,255,255,.07);--bd2:rgba(255,255,255,.14);
  --up:#10D98A;--dn:#FF4D6D;--fl:#6B7A99;--ac:#3B7BF6;--go:#F5A623;--pu:#9B6EFF;--or:#FF7A3D;
  --t1:#EFF3FA;--t2:#94A3B8;--t3:#4B5875;
  --mono:'DM Mono',monospace;--sans:'Noto Sans KR',sans-serif;
  --r8:8px;--r12:12px;--r16:16px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--sans);background:var(--bg);color:var(--t1);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:99px}

@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.2}}
@keyframes ticker{from{transform:translateX(0)}to{transform:translateX(-50%)}}
@keyframes spin{to{transform:rotate(360deg)}}
.fu{animation:fadeUp .35s ease both}

/* ë ˆì´ì•„ì›ƒ */
.wrap{max-width:500px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column}

/* í‹°ì»¤ */
.ticker-band{background:#060A10;border-bottom:1px solid var(--bd);overflow:hidden;height:26px;display:flex;align-items:center;flex-shrink:0}
.ticker-inner{display:flex;animation:ticker 36s linear infinite;white-space:nowrap}
.tk{display:inline-flex;align-items:center;gap:5px;padding:0 16px;font-family:var(--mono);font-size:10px;border-right:1px solid var(--bd)}
.tk-n{color:var(--t2)}.up{color:var(--up)}.dn{color:var(--dn)}

/* í—¤ë” */
.hdr{position:sticky;top:0;z-index:200;background:rgba(8,12,20,.96);backdrop-filter:blur(20px);border-bottom:1px solid var(--bd);padding:10px 14px 0;flex-shrink:0}
.hdr-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.logo{display:flex;align-items:center;gap:8px}
.logo-mark{width:28px;height:28px;border-radius:var(--r8);background:linear-gradient(135deg,var(--ac),var(--pu));display:flex;align-items:center;justify-content:center;font-size:13px}
.logo-nm{font-size:16px;font-weight:900;letter-spacing:-.3px}
.hdr-r{display:flex;align-items:center;gap:7px}
.live-pill{display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:99px;font-size:9px;font-weight:700;border:1px solid}
.live-dot{width:5px;height:5px;border-radius:50%}
.clk{font-family:var(--mono);font-size:10px;color:var(--t3)}
.tabs{display:flex;gap:0;overflow-x:auto;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{flex-shrink:0;padding:7px 11px;font-size:11px;font-weight:500;color:var(--t3);background:transparent;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all .2s;white-space:nowrap;font-family:var(--sans)}
.tab.on{color:var(--t1);border-bottom-color:var(--ac);font-weight:700}

/* ë°ì´í„° ê¸°ì¤€ì¼ ë°” */
.date-bar{display:flex;align-items:center;justify-content:space-between;padding:6px 14px;background:rgba(59,123,246,.04);border-bottom:1px solid var(--bd);flex-shrink:0}
.date-info{font-size:10px;color:var(--t3)}
.date-info strong{color:var(--ac);font-weight:600}
.date-refresh{font-size:10px;color:var(--ac);cursor:pointer;font-weight:600}

/* ë³¸ë¬¸ */
.main{flex:1;padding:10px 10px 90px;display:flex;flex-direction:column;gap:9px;overflow-y:auto}
.panel{display:none;flex-direction:column;gap:9px}
.panel.on{display:flex}

/* ì¹´ë“œ */
.card{background:var(--sf);border:1px solid var(--bd);border-radius:var(--r16);overflow:hidden}
.card-h{display:flex;justify-content:space-between;align-items:center;padding:10px 13px 8px;border-bottom:1px solid var(--bd)}
.card-t{font-size:10px;font-weight:700;color:var(--t2);letter-spacing:.5px;text-transform:uppercase}
.card-m{font-size:10px;color:var(--ac);cursor:pointer;font-weight:600}
.card-b{padding:10px 13px}

/* ì§€ìˆ˜ ê·¸ë¦¬ë“œ */
.idx-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.idx-c{background:var(--sf);border:1px solid var(--bd);border-radius:var(--r12);padding:9px 10px;cursor:pointer;transition:border-color .2s;position:relative;overflow:hidden}
.idx-c:hover{border-color:var(--bd2)}
.idx-c::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.idx-c.up::before{background:var(--up)}.idx-c.dn::before{background:var(--dn)}
.idx-nm{font-size:8px;font-weight:700;color:var(--t3);letter-spacing:.5px;text-transform:uppercase;margin-bottom:3px}
.idx-v{font-family:var(--mono);font-size:14px;font-weight:500;line-height:1}
.idx-ch{font-family:var(--mono);font-size:9.5px;margin-top:2px}
.idx-vol{font-size:8.5px;color:var(--t3);margin-top:3px}

/* ì‹œì¥ ìš”ì•½ */
.summary-box{background:linear-gradient(135deg,rgba(59,123,246,.08),rgba(155,110,255,.05));border:1px solid rgba(59,123,246,.18);border-radius:var(--r12);padding:12px 13px}
.summary-label{font-size:9px;font-weight:700;color:var(--ac);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.summary-date{font-size:9px;color:var(--t3);font-weight:400}
.summary-line{font-size:12px;color:var(--t2);line-height:1.7;padding:2px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.summary-line:last-child{border-bottom:none}

/* ìˆ˜ê¸‰ ë°” */
.sup-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--bd)}
.sup-row:last-child{border-bottom:none}
.sup-nm{width:38px;font-size:11px;font-weight:500;color:var(--t2);flex-shrink:0}
.sup-bw{flex:1;height:5px;background:rgba(255,255,255,.06);border-radius:99px;overflow:hidden}
.sup-bf{height:100%;border-radius:99px;transition:width .8s ease}
.sup-bf.up{background:linear-gradient(90deg,#0EA86B,var(--up))}
.sup-bf.dn{background:linear-gradient(90deg,#CC2244,var(--dn))}
.sup-val{width:70px;text-align:right;font-family:var(--mono);font-size:11px;font-weight:500;flex-shrink:0}

/* ê¸°ê°„ íƒ­ */
.period-tabs{display:flex;gap:4px}
.period-tab{flex:1;padding:6px;font-size:11px;font-weight:600;border-radius:var(--r8);border:1px solid var(--bd);background:transparent;color:var(--t3);cursor:pointer;transition:all .2s;font-family:var(--sans)}
.period-tab.on{background:rgba(59,123,246,.12);border-color:rgba(59,123,246,.3);color:var(--ac)}

/* í†µê³„ ê·¸ë¦¬ë“œ */
.stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
.stat-c{background:var(--sf);border:1px solid var(--bd);border-radius:var(--r12);padding:11px 12px}
.stat-l{font-size:9.5px;color:var(--t3);margin-bottom:4px;font-weight:500}
.stat-v{font-size:26px;font-weight:900;line-height:1}
.stat-s{font-size:9.5px;color:var(--t3);margin-top:2px}

/* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
.list-item{display:flex;align-items:center;gap:8px;padding:9px 0;border-bottom:1px solid var(--bd);cursor:pointer;transition:background .15s}
.list-item:last-child{border-bottom:none}
.list-item:active{background:rgba(255,255,255,.03)}
.li-no{width:16px;font-size:9.5px;color:var(--t3);font-family:var(--mono);text-align:center;flex-shrink:0}
.li-info{flex:1;min-width:0}
.li-name{font-size:12.5px;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.li-sub{font-size:10px;color:var(--t3);margin-top:1px;display:flex;align-items:center;gap:5px}
.li-r{text-align:right;flex-shrink:0}
.li-price{font-family:var(--mono);font-size:12px;font-weight:500}
.li-chg{font-family:var(--mono);font-size:10px;margin-top:1px}
.li-amt{font-family:var(--mono);font-size:11px;font-weight:500}

/* ë°°ì§€ */
.badge{font-size:8.5px;font-weight:700;padding:1.5px 5px;border-radius:3px;white-space:nowrap}
.mkt-k{background:rgba(59,123,246,.15);color:var(--ac)}
.mkt-q{background:rgba(155,110,255,.15);color:var(--pu)}

/* ë”ë³´ê¸° ë²„íŠ¼ */
.more-btn{display:flex;align-items:center;justify-content:center;gap:5px;padding:9px;font-size:11.5px;color:var(--ac);cursor:pointer;border-top:1px solid var(--bd);font-weight:600}
.more-section{display:none;padding:0 13px 10px}
.more-section.open{display:block}

/* Phase ì¹© */
.p-chips{display:flex;gap:4px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px}
.p-chips::-webkit-scrollbar{display:none}
.p-chip{flex-shrink:0;padding:5px 10px;font-size:10.5px;font-weight:600;border-radius:99px;border:1px solid var(--bd);background:transparent;color:var(--t3);cursor:pointer;transition:all .2s;font-family:var(--sans)}
.p-chip.on{color:var(--t1);border-color:var(--bd2);background:rgba(255,255,255,.07)}

/* ì„¹í„° íˆíŠ¸ë§µ */
.hm-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px}
.hm-c{border-radius:var(--r8);padding:9px 8px;cursor:pointer;transition:opacity .2s,transform .15s}
.hm-c:active{opacity:.8;transform:scale(.97)}
.hm-n{font-size:10.5px;font-weight:700;color:#fff;line-height:1.2;margin-bottom:2px}
.hm-ch{font-family:var(--mono);font-size:12px;color:rgba(255,255,255,.9)}
.hm-vol{font-size:8.5px;color:rgba(255,255,255,.5);margin-top:2px}

/* ì„¹í„° ë°” */
.sec-item{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--bd);cursor:pointer}
.sec-item:last-child{border-bottom:none}
.sec-rk{width:14px;font-size:9.5px;color:var(--t3);font-family:var(--mono);flex-shrink:0}
.sec-nm{width:70px;font-size:11.5px;color:var(--t1);flex-shrink:0;font-weight:500}
.sec-bw{flex:1;height:5px;background:rgba(255,255,255,.05);border-radius:99px;overflow:hidden}
.sec-bf{height:100%;border-radius:99px}
.sec-pct{width:44px;text-align:right;font-family:var(--mono);font-size:11.5px;font-weight:600;flex-shrink:0}
.sec-tv{width:38px;text-align:right;font-size:9.5px;color:var(--t3);flex-shrink:0}

/* ì‹ ê³ ê°€ íƒ­ ë²„íŠ¼ */
.nh-tabs{display:flex;gap:5px;margin-bottom:8px}
.nh-tab{flex:1;padding:7px;font-size:11px;font-weight:700;border:1px solid var(--bd);border-radius:var(--r8);background:transparent;color:var(--t3);cursor:pointer;transition:all .2s;font-family:var(--sans)}
.nh-tab.hi{background:rgba(16,217,138,.1);border-color:rgba(16,217,138,.28);color:var(--up)}
.nh-tab.lo{background:rgba(255,77,109,.1);border-color:rgba(255,77,109,.28);color:var(--dn)}

/* ëª¨ë‹¬ */
.modal-bg{position:fixed;inset:0;z-index:500;display:flex;align-items:flex-end;background:rgba(0,0,0,.65);backdrop-filter:blur(4px)}
.modal-bg.hidden{display:none}
.modal-sheet{background:var(--bg2);border-radius:22px 22px 0 0;padding:18px 15px calc(30px + env(safe-area-inset-bottom));width:100%;max-width:500px;margin:0 auto;max-height:88dvh;overflow-y:auto;border-top:1px solid var(--bd)}
.modal-handle{width:36px;height:4px;background:var(--bd2);border-radius:99px;margin:0 auto 14px}
.modal-title{font-size:16px;font-weight:700;margin-bottom:4px}
.modal-sub{font-size:10.5px;color:var(--t3);margin-bottom:14px}
.modal-close{display:block;text-align:center;padding:12px;font-size:12px;color:var(--t3);cursor:pointer;margin-top:10px;border-top:1px solid var(--bd)}
.modal-section{margin-bottom:16px}
.modal-section-t{font-size:9.5px;font-weight:700;color:var(--t3);letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--bd)}

/* SVG ì°¨íŠ¸ */
.chart-wrap{margin:10px 0;border-radius:var(--r8);overflow:hidden;background:rgba(255,255,255,.02)}
.chart-wrap svg{display:block;width:100%}

/* ë¡œë”© */
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px;gap:12px}
.spinner{width:26px;height:26px;border:3px solid var(--bd);border-top-color:var(--ac);border-radius:50%;animation:spin .8s linear infinite}
.error-box{background:rgba(255,77,109,.08);border:1px solid rgba(255,77,109,.2);border-radius:var(--r12);padding:16px;text-align:center;color:var(--dn);font-size:13px}

/* ë¹ˆ ìƒíƒœ */
.empty{padding:20px;text-align:center;color:var(--t3);font-size:12px}

/* í•˜ë‹¨ ë„¤ë¹„ */
.bot-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:500px;background:rgba(8,12,20,.97);backdrop-filter:blur(20px);border-top:1px solid var(--bd);display:flex;padding:5px 0 calc(5px + env(safe-area-inset-bottom));z-index:200}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:5px 0;background:transparent;border:none;cursor:pointer;font-family:var(--sans)}
.nav-ic{font-size:17px;line-height:1}
.nav-lb{font-size:9px;font-weight:600;color:var(--t3);transition:color .2s}
.nav-btn.on .nav-lb{color:var(--ac)}

/* ìœ í‹¸ */
.mono{font-family:var(--mono)}
.t2{color:var(--t2)}.t3{color:var(--t3)}
.fs10{font-size:10px}
</style>
</head>
<body>
<div class="wrap">

<!-- í‹°ì»¤ -->
<div class="ticker-band"><div class="ticker-inner" id="tickerEl"></div></div>

<!-- í—¤ë” -->
<header class="hdr">
  <div class="hdr-top">
    <div class="logo">
      <div class="logo-mark">ğŸ“¡</div>
      <div class="logo-nm">MARKET RADAR</div>
    </div>
    <div class="hdr-r">
      <div class="live-pill" id="livePill">
        <div class="live-dot" id="liveDot"></div>
        <span id="liveLabel">--</span>
      </div>
      <div class="clk" id="clockEl">--:--:--</div>
    </div>
  </div>
  <div class="tabs">
    <button class="tab on" data-t="0">ì¢…í•©</button>
    <button class="tab" data-t="1">ìˆ˜ê¸‰</button>
    <button class="tab" data-t="2">ì„¹í„°</button>
    <button class="tab" data-t="3">ì‹ ê³ ê°€</button>
    <button class="tab" data-t="4">Phase</button>
  </div>
</header>

<!-- ë°ì´í„° ê¸°ì¤€ì¼ ë°” -->
<div class="date-bar">
  <div class="date-info">ğŸ“… ë°ì´í„° ê¸°ì¤€: <strong id="dateBadgeText">ë¡œë”© ì¤‘...</strong></div>
  <div class="date-refresh" onclick="loadData()">â†» ìƒˆë¡œê³ ì¹¨</div>
</div>

<!-- ë³¸ë¬¸ -->
<main class="main" id="mainEl">
  <div class="loading" id="loadingEl">
    <div class="spinner"></div>
    <div style="font-size:12px;color:var(--t3)">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>

  <!-- TAB 0: ì¢…í•© -->
  <div class="panel fu" data-p="0">
    <div class="idx-grid" id="idxGrid"></div>
    <div class="summary-box">
      <div class="summary-label">
        ğŸ“‹ ì˜¤ëŠ˜ì˜ ì‹œì¥ ìš”ì•½
        <span class="summary-date" id="summaryDate"></span>
      </div>
      <div id="summaryLines"></div>
    </div>
    <div class="card">
      <div class="card-h"><span class="card-t">ì‹œì¥ ìˆ˜ê¸‰</span><span class="card-m" data-goto="1">ìì„¸íˆ â†’</span></div>
      <div class="card-b" id="supplyHome"></div>
    </div>
    <div class="stat-grid" id="statHome"></div>
    <div class="card">
      <div class="card-h"><span class="card-t">ğŸ”¥ ì£¼ëª© ì¢…ëª©</span><span class="card-m" data-goto="4">ì „ì²´ â†’</span></div>
      <div class="card-b" style="padding:2px 13px 10px" id="hotStocks"></div>
    </div>
  </div>

  <!-- TAB 1: ìˆ˜ê¸‰ -->
  <div class="panel" data-p="1">
    <div class="period-tabs">
      <button class="period-tab on" onclick="setPeriod('day')">ì˜¤ëŠ˜</button>
      <button class="period-tab" onclick="setPeriod('week')">1ì£¼ì¼</button>
      <button class="period-tab" onclick="setPeriod('month')">1ê°œì›”</button>
    </div>
    <div class="card">
      <div class="card-h"><span class="card-t" id="supCardT">ì‹œì¥ ì „ì²´ ìˆ˜ê¸‰</span></div>
      <div class="card-b" id="mktSupply"></div>
    </div>
    <div class="card">
      <div class="card-h"><span class="card-t">ğŸ’° ì™¸êµ­ì¸ Top ë§¤ìˆ˜Â·ë§¤ë„</span></div>
      <div class="card-b" style="padding:2px 13px 10px" id="topForeign"></div>
      <div class="more-btn" onclick="toggleMore('fMore')">â–¾ ë”ë³´ê¸°</div>
      <div class="more-section" id="fMore"></div>
    </div>
    <div class="card">
      <div class="card-h"><span class="card-t">ğŸ›ï¸ ê¸°ê´€ Top ë§¤ìˆ˜Â·ë§¤ë„</span></div>
      <div class="card-b" style="padding:2px 13px 10px" id="topInst"></div>
      <div class="more-btn" onclick="toggleMore('iMore')">â–¾ ë”ë³´ê¸°</div>
      <div class="more-section" id="iMore"></div>
    </div>
    <div class="card">
      <div class="card-h"><span class="card-t">ğŸ‘¤ ê°œì¸ Top ë§¤ìˆ˜Â·ë§¤ë„</span></div>
      <div class="card-b" style="padding:2px 13px 10px" id="topIndiv"></div>
    </div>
    <div class="card">
      <div class="card-h"><span class="card-t">ğŸ”µ ì™¸ì¸ ì—°ì† ìˆœë§¤ìˆ˜</span></div>
      <div class="card-b" style="padding:2px 13px 10px" id="fConsList"></div>
      <div class="more-btn" onclick="toggleMore('fcMore')">â–¾ ë”ë³´ê¸°</div>
      <div class="more-section" id="fcMore"></div>
    </div>
    <div class="card">
      <div class="card-h"><span class="card-t">ğŸŸ¡ ê¸°ê´€ ì—°ì† ìˆœë§¤ìˆ˜</span></div>
      <div class="card-b" style="padding:2px 13px 10px" id="iConsList"></div>
      <div class="more-btn" onclick="toggleMore('icMore')">â–¾ ë”ë³´ê¸°</div>
      <div class="more-section" id="icMore"></div>
    </div>
  </div>

  <!-- TAB 2: ì„¹í„° -->
  <div class="panel" data-p="2">
    <div class="card">
      <div class="card-h">
        <span class="card-t">ì—…ì¢… íˆíŠ¸ë§µ</span>
        <span class="fs10 t3" id="sectorDateLabel"></span>
      </div>
      <div class="card-b"><div class="hm-grid" id="hmGrid"></div></div>
    </div>
    <div class="card">
      <div class="card-h"><span class="card-t">ì—…ì¢…ë³„ ë“±ë½ë¥  Â· ê±°ë˜ëŒ€ê¸ˆ</span></div>
      <div class="card-b" style="padding:4px 13px 12px" id="secList"></div>
    </div>
  </div>

  <!-- TAB 3: ì‹ ê³ ê°€ -->
  <div class="panel" data-p="3">
    <div class="nh-tabs">
      <button class="nh-tab hi" id="nhHBtn" onclick="switchNH('h')">ğŸ“ ì‹ ê³ ê°€</button>
      <button class="nh-tab" id="nhLBtn" onclick="switchNH('l')">ğŸ“‰ ì‹ ì €ê°€</button>
    </div>
    <div class="card">
      <div class="card-h"><span class="card-t" id="nhCardT">52ì£¼ ì‹ ê³ ê°€ ì¢…ëª©</span><span class="fs10 t3" id="nhDateLabel"></span></div>
      <div class="card-b" style="padding:2px 13px 10px" id="nhList"></div>
    </div>
  </div>

  <!-- TAB 4: Phase -->
  <div class="panel" data-p="4">
    <div class="stat-grid" id="phaseStatGrid"></div>
    <div class="p-chips" id="pChips"></div>
    <div class="card">
      <div class="card-h"><span class="card-t" id="phaseCardT">Phase ì‹ í˜¸ ì¢…ëª©</span><span class="fs10 t3" id="phaseDateLabel"></span></div>
      <div class="card-b" style="padding:2px 13px 10px" id="phaseList"></div>
    </div>
  </div>
</main>

<!-- ì§€ìˆ˜ ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal-bg hidden" id="idxModal" onclick="closeModal('idxModal',event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title" id="idxModalTitle"></div>
    <div class="modal-sub" id="idxModalSub"></div>
    <div id="idxModalBody"></div>
    <div class="modal-close" onclick="closeModalDirect('idxModal')">ë‹«ê¸°</div>
  </div>
</div>

<!-- ì¢…ëª© ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal-bg hidden" id="stockModal" onclick="closeModal('stockModal',event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title" id="stkModalTitle"></div>
    <div class="modal-sub" id="stkModalSub"></div>
    <div id="stkModalBody"></div>
    <div class="modal-close" onclick="closeModalDirect('stockModal')">ë‹«ê¸°</div>
  </div>
</div>

<!-- ì„¹í„° ëª¨ë‹¬ -->
<div class="modal-bg hidden" id="secModal" onclick="closeModal('secModal',event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title" id="secModalTitle"></div>
    <div class="modal-sub" id="secModalSub"></div>
    <div id="secModalBody"></div>
    <div class="modal-close" onclick="closeModalDirect('secModal')">ë‹«ê¸°</div>
  </div>
</div>

<!-- í•˜ë‹¨ ë„¤ë¹„ -->
<nav class="bot-nav">
  <button class="nav-btn on" data-n="0"><span class="nav-ic">ğŸ“Š</span><span class="nav-lb">ì¢…í•©</span></button>
  <button class="nav-btn" data-n="1"><span class="nav-ic">ğŸ’°</span><span class="nav-lb">ìˆ˜ê¸‰</span></button>
  <button class="nav-btn" data-n="2"><span class="nav-ic">ğŸ­</span><span class="nav-lb">ì„¹í„°</span></button>
  <button class="nav-btn" data-n="3"><span class="nav-ic">ğŸš€</span><span class="nav-lb">ì‹ ê³ ê°€</span></button>
  <button class="nav-btn" data-n="4"><span class="nav-ic">ğŸ“¡</span><span class="nav-lb">ì‹ í˜¸</span></button>
</nav>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì „ì—­ ìƒíƒœ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let G = null;
let _period = 'day';
let _nhMode = 'h';
let _pFilter = 'all';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìœ í‹¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const fmtN = n => Number(n||0).toLocaleString('ko');
const fmtP = n => (n>=0?'+':'')+Number(n).toFixed(2)+'%';
function fmtAmt(n) {
  const s = n>=0?'+':'-', a = Math.abs(n);
  if(a>=1e12) return s+(a/1e12).toFixed(1)+'ì¡°';
  if(a>=1e8)  return s+(a/1e8).toFixed(0)+'ì–µ';
  if(a>=1e4)  return s+(a/1e4).toFixed(0)+'ë§Œ';
  return (n>=0?'+':'')+fmtN(n);
}
function mktBadge(m) {
  return m==='KOSDAQ'
    ? '<span class="badge mkt-q">KOSDAQ</span>'
    : '<span class="badge mkt-k">KOSPI</span>';
}
function phaseColor(k) {
  return {golden:'#F5A623',p2:'#10D98A',p1:'#3B7BF6',p3:'#FF4D6D'}[k]||'#94A3B8';
}

// SVG ë¼ì¸ ì°¨íŠ¸ ìƒì„±
function makeSVGChart(data, color='#3B7BF6', h=52, showDots=true) {
  if(!data||data.length<2) return '<div style="height:'+h+'px;display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--t3)">ë°ì´í„° ì—†ìŒ</div>';
  const w=400, pad=4;
  const vals = data.map(d=>typeof d==='object'?d.v:d);
  const mn=Math.min(...vals), mx=Math.max(...vals), rng=mx-mn||1;
  const pts = vals.map((v,i)=>{
    const x = pad + (i/(vals.length-1))*(w-pad*2);
    const y = pad + (1-(v-mn)/rng)*(h-pad*2);
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  });
  const lx=parseFloat(pts[pts.length-1].split(',')[0]);
  const ly=parseFloat(pts[pts.length-1].split(',')[1]);
  const fill = `${pts[0].split(',')[0]},${h} ${pts.map(p=>p).join(' ')} ${pts[pts.length-1].split(',')[0]},${h}`;
  return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" style="width:100%;height:${h}px">
    <defs><linearGradient id="g${color.replace('#','')}" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="${color}" stop-opacity="0.2"/>
      <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
    </linearGradient></defs>
    <polygon points="${fill}" fill="url(#g${color.replace('#','')})" />
    <polyline points="${pts.join(' ')}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round"/>
    ${showDots?`<circle cx="${lx}" cy="${ly}" r="3" fill="${color}"/>`:''}
  </svg>`;
}

// ì„¹í„° ê·¸ë£¹í•‘
function groupBySector(stocks) {
  const map = {};
  stocks.forEach(s => {
    const sec = s.sector || 'ê¸°íƒ€';
    if(!map[sec]) map[sec] = {name:sec, stocks:[], totalTrVal:0, avgChange:0};
    map[sec].stocks.push(s);
    map[sec].totalTrVal += (s.tr_val||0);
  });
  Object.values(map).forEach(g => {
    g.avgChange = g.stocks.reduce((a,s)=>a+s.change,0)/g.stocks.length;
    g.stocks.sort((a,b)=>(b.tr_val||0)-(a.tr_val||0));
  });
  return Object.values(map).sort((a,b)=>b.totalTrVal-a.totalTrVal);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë°ì´í„° ë¡œë“œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadData() {
  try {
    const resp = await fetch(`data/market.json?t=${Date.now()}`);
    if(!resp.ok) throw new Error('market.json ì—†ìŒ');
    G = await resp.json();
    document.getElementById('loadingEl').style.display='none';
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('on'));
    const activeTab = document.querySelector('.tab.on');
    const tabIdx = activeTab ? activeTab.dataset.t : '0';
    document.querySelector(`.panel[data-p="${tabIdx}"]`)?.classList.add('on');

    // ê¸°ì¤€ì¼ í‘œì‹œ
    const dateText = G.date || G.updated_at?.split(' ')[0] || '-';
    const timeText = G.updated_at || '-';
    document.getElementById('dateBadgeText').textContent = `${dateText} (ì—…ë°ì´íŠ¸: ${timeText})`;

    renderAll();
  } catch(e) {
    document.getElementById('loadingEl').innerHTML =
      `<div class="error-box">âš ï¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><small style="color:var(--t3);margin-top:6px;display:block">GitHub Actionsì—ì„œ Run workflowë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”</small></div>`;
  }
}

function renderAll() {
  if(!G) return;
  renderTicker();
  renderTab0();
  renderTab1();
  renderTab2();
  renderTab3();
  renderTab4();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 0: ì¢…í•©
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTab0() {
  // ì§€ìˆ˜
  const indices = G.indices||[];
  document.getElementById('idxGrid').innerHTML = indices.length
    ? indices.map(i=>{
        const up=i.change>=0;
        return `<div class="idx-c ${up?'up':'dn'}" onclick="openIdxModal('${i.name}')">
          <div class="idx-nm">${i.name}</div>
          <div class="idx-v ${up?'up':'dn'}">${fmtN(i.value)}</div>
          <div class="idx-ch ${up?'up':'dn'}">${fmtP(i.change)}</div>
          <div class="idx-vol">${i.vol||''}</div>
        </div>`;
      }).join('')
    : '<div class="error-box" style="grid-column:span 3;font-size:11px">ì§€ìˆ˜ ë°ì´í„° ì—†ìŒ (ì¥ë§ˆê° í›„ ë˜ëŠ” API ì˜¤ë¥˜)</div>';

  // ìš”ì•½
  const lines = G.summary_lines||[];
  const date = G.date||'-';
  document.getElementById('summaryDate').textContent = `${date} ê¸°ì¤€`;
  document.getElementById('summaryLines').innerHTML = lines.length
    ? lines.map(l=>`<div class="summary-line">${l}</div>`).join('')
    : '<div class="summary-line t3">ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</div>';

  // ìˆ˜ê¸‰ ë°”
  renderSupplyBars('supplyHome', G.market_supply||{});

  // í†µê³„
  const ps = G.phase_stats||{};
  document.getElementById('statHome').innerHTML = [
    {l:'â­ GOLDEN',v:ps.golden||0,c:'#F5A623'},
    {l:'ğŸš€ ì‹ ê³ ê°€',v:ps.new_high||0,c:'#F97316'},
    {l:'ğŸ”µ P1 ë§¤ì§‘',v:ps.p1||0,c:'#3B7BF6'},
    {l:'ğŸ”´ P3 ê²½ê³ ',v:ps.p3||0,c:'#FF4D6D'},
  ].map(s=>`<div class="stat-c" style="border-color:${s.c}22">
    <div class="stat-l">${s.l}</div>
    <div class="stat-v" style="color:${s.c}">${s.v}</div>
    <div class="stat-s">ì¢…ëª© (${date})</div>
  </div>`).join('');

  // ì£¼ëª© ì¢…ëª©
  const hot = (G.stocks||[]).filter(s=>s.phase).slice(0,5);
  document.getElementById('hotStocks').innerHTML = hot.length
    ? hot.map((s,i)=>{
        const up=s.change>=0, pc=phaseColor(s.phase_key);
        return `<div class="list-item" onclick="openStockModal('${s.code}')">
          <div class="li-no">${i+1}</div>
          <div class="li-info">
            <div class="li-name">${s.name} ${mktBadge(s.market)}</div>
            <div class="li-sub">
              <span class="badge" style="color:${pc};background:${pc}18">${s.phase}</span>
              ${s.nh_flag?`<span class="badge" style="color:#F97316;background:#F9731618">${s.nh_flag}</span>`:''}
            </div>
          </div>
          <div class="li-r">
            <div class="li-price ${up?'up':'dn'}">${fmtN(s.price)}</div>
            <div class="li-chg ${up?'up':'dn'}">${fmtP(s.change)}</div>
          </div>
        </div>`;
      }).join('')
    : '<div class="empty">ì‹ í˜¸ ì¢…ëª© ì—†ìŒ</div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 1: ìˆ˜ê¸‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setPeriod(p) {
  _period = p;
  document.querySelectorAll('.period-tab').forEach((b,i)=>{
    b.classList.toggle('on', ['day','week','month'][i]===p);
  });
  const labels={day:'ì˜¤ëŠ˜',week:'1ì£¼ì¼',month:'1ê°œì›”'};
  document.getElementById('supCardT').textContent = `ì‹œì¥ ì „ì²´ ìˆ˜ê¸‰ (${labels[p]})`;
  renderTab1();
}

function renderTab1() {
  const ms = G?.market_supply||{};
  const stocks = G?.stocks||[];
  const date = G?.date||'-';

  // ì‹œì¥ ìˆ˜ê¸‰ (ê¸°ê°„ë³„)
  let fn=ms.foreign_net||0, inn=ms.inst_net||0, iv=ms.indiv_net||0;
  if(_period!=='day') {
    fn=inn=iv=0;
    stocks.forEach(s=>{
      const sp=(s.supply_periods||{})[_period]||{};
      fn+=sp.foreign||0; inn+=sp.inst||0; iv+=sp.indiv||0;
    });
  }
  renderSupplyBars('mktSupply', {foreign_net:fn, inst_net:inn, indiv_net:iv});

  // Top ê±°ë˜ì£¼ì²´
  renderTopTrader('topForeign','fMore','foreign','ì™¸êµ­ì¸',stocks,date);
  renderTopTrader('topInst','iMore','inst','ê¸°ê´€',stocks,date);
  renderTopTrader('topIndiv',null,'indiv','ê°œì¸',stocks,date);

  // ì—°ì† ìˆœë§¤ìˆ˜
  renderConsec('fConsList','fcMore','f_consec','foreign_today','ì™¸ì¸',stocks);
  renderConsec('iConsList','icMore','i_consec','inst_today','ê¸°ê´€',stocks);
}

function renderSupplyBars(elId, ms) {
  const rows=[
    {nm:'ì™¸êµ­ì¸',v:ms.foreign_net||0},
    {nm:'ê¸°ê´€',  v:ms.inst_net||0},
    {nm:'ê°œì¸',  v:ms.indiv_net||0},
  ];
  const maxA=Math.max(...rows.map(r=>Math.abs(r.v)),1);
  document.getElementById(elId).innerHTML = rows.map(r=>{
    const up=r.v>=0, pct=Math.abs(r.v)/maxA*100;
    return `<div class="sup-row">
      <div class="sup-nm">${r.nm}</div>
      <div class="sup-bw"><div class="sup-bf ${up?'up':'dn'}" style="width:${pct}%"></div></div>
      <div class="sup-val ${up?'up':'dn'}">${fmtAmt(r.v)}</div>
    </div>`;
  }).join('');
}

function renderTopTrader(elId, moreId, actor, label, stocks, date) {
  const key = actor+'_today';
  const buying  = stocks.filter(s=>s[key]>0).sort((a,b)=>b[key]-a[key]);
  const selling = stocks.filter(s=>s[key]<0).sort((a,b)=>a[key]-b[key]);

  function mkRow(s,i,isBuy) {
    const up=s.change>=0;
    return `<div class="list-item" onclick="openStockModal('${s.code}')">
      <div class="li-no">${i+1}</div>
      <div class="li-info">
        <div class="li-name">${s.name} ${mktBadge(s.market)}</div>
        <div class="li-sub t3">${fmtN(s.price)}ì› Â· ${date}</div>
      </div>
      <div class="li-r">
        <div class="li-amt ${isBuy?'up':'dn'}">${fmtAmt(s[key])}</div>
        <div class="li-chg ${up?'up':'dn'}">${fmtP(s.change)}</div>
      </div>
    </div>`;
  }

  const top10B = buying.slice(0,10), top10S = selling.slice(0,10);
  const more50B = buying.slice(10,50), more50S = selling.slice(10,50);

  const headerBuy  = `<div style="font-size:10px;font-weight:700;color:var(--up);padding:8px 0 4px;border-bottom:1px solid var(--bd)">${label} ìƒìœ„ ë§¤ìˆ˜ (${date})</div>`;
  const headerSell = `<div style="font-size:10px;font-weight:700;color:var(--dn);padding:8px 0 4px;border-bottom:1px solid var(--bd)">${label} ìƒìœ„ ë§¤ë„ (${date})</div>`;

  document.getElementById(elId).innerHTML =
    headerBuy + (top10B.length?top10B.map((s,i)=>mkRow(s,i,true)).join(''):'<div class="empty">ë°ì´í„° ì—†ìŒ</div>') +
    headerSell + (top10S.length?top10S.map((s,i)=>mkRow(s,i,false)).join(''):'<div class="empty">ë°ì´í„° ì—†ìŒ</div>');

  if(moreId) {
    document.getElementById(moreId).innerHTML =
      (more50B.length?headerBuy+more50B.map((s,i)=>mkRow(s,i+10,true)).join(''):'') +
      (more50S.length?headerSell+more50S.map((s,i)=>mkRow(s,i+10,false)).join(''):'');
  }
}

function renderConsec(elId, moreId, consecKey, amtKey, label, stocks) {
  const sorted = stocks.filter(s=>s[consecKey]>0).sort((a,b)=>b[consecKey]-a[consecKey]);
  const color = label==='ì™¸ì¸'?'#3B7BF6':'#F5A623';

  function mkRow(s,i) {
    const up=s.change>=0;
    return `<div class="list-item" onclick="openStockModal('${s.code}')">
      <div class="li-no">${i+1}</div>
      <div class="li-info">
        <div class="li-name">${s.name} ${mktBadge(s.market)}</div>
        <div class="li-sub">
          <span style="color:${color};font-weight:700;font-size:10px">${s[consecKey]}ì¼ ì—°ì†</span>
          <span class="t3">${fmtN(s.price)}ì›</span>
        </div>
      </div>
      <div class="li-r">
        <div class="li-amt up">${fmtAmt(s[amtKey]||0)}</div>
        <div class="li-chg ${up?'up':'dn'}">${fmtP(s.change)}</div>
      </div>
    </div>`;
  }

  document.getElementById(elId).innerHTML = sorted.slice(0,10).length
    ? sorted.slice(0,10).map((s,i)=>mkRow(s,i)).join('')
    : '<div class="empty">ë°ì´í„° ì—†ìŒ</div>';

  if(moreId) {
    document.getElementById(moreId).innerHTML = sorted.slice(10,50).map((s,i)=>mkRow(s,i+10)).join('');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 2: ì„¹í„°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTab2() {
  const stocks = G?.stocks||[];
  const date = G?.date||'-';
  document.getElementById('sectorDateLabel').textContent = date+' ê¸°ì¤€';

  const sectors = groupBySector(stocks);
  if(!sectors.length) {
    document.getElementById('hmGrid').innerHTML='<div class="empty" style="grid-column:span 3">ë°ì´í„° ì—†ìŒ</div>';
    return;
  }
  const maxTv = Math.max(...sectors.map(s=>s.totalTrVal),1);

  // íˆíŠ¸ë§µ (ìƒìœ„ 12ê°œ)
  document.getElementById('hmGrid').innerHTML = sectors.slice(0,12).map((sec,i)=>{
    const up=sec.avgChange>=0, inten=Math.min(Math.abs(sec.avgChange)/8,1);
    const base = up?'14,122,78':'180,30,50';
    const bg=`rgba(${base},${0.22+inten*.55})`;
    return `<div class="hm-c" style="background:${bg};border:1px solid rgba(${base},.4)" onclick="openSecModal(${i})">
      <div class="hm-n">${sec.name}</div>
      <div class="hm-ch">${sec.avgChange>=0?'+':''}${sec.avgChange.toFixed(2)}%</div>
      <div class="hm-vol">${fmtAmt(sec.totalTrVal)}</div>
    </div>`;
  }).join('');

  // ì„¹í„° ë°” ë¦¬ìŠ¤íŠ¸
  const sorted=[...sectors].sort((a,b)=>b.avgChange-a.avgChange);
  const maxAbs=Math.max(...sorted.map(s=>Math.abs(s.avgChange)),1);
  document.getElementById('secList').innerHTML = sorted.map((sec,i)=>{
    const up=sec.avgChange>=0, pct=Math.abs(sec.avgChange)/maxAbs*100;
    const idx=sectors.indexOf(sec);
    return `<div class="sec-item" onclick="openSecModal(${idx})">
      <div class="sec-rk">${i+1}</div>
      <div class="sec-nm">${sec.name}</div>
      <div class="sec-bw"><div class="sec-bf" style="width:${pct}%;background:${up?'linear-gradient(90deg,#0EA86B,var(--up))':'linear-gradient(90deg,#CC2244,var(--dn))'}"></div></div>
      <div class="sec-pct ${up?'up':'dn'}">${up?'+':''}${sec.avgChange.toFixed(2)}%</div>
      <div class="sec-tv t3">${fmtAmt(sec.totalTrVal)}</div>
    </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 3: ì‹ ê³ ê°€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchNH(mode) {
  _nhMode=mode;
  document.getElementById('nhHBtn').className='nh-tab '+(mode==='h'?'hi':'');
  document.getElementById('nhLBtn').className='nh-tab '+(mode==='l'?'lo':'');
  renderTab3();
}

function renderTab3() {
  const stocks = G?.stocks||[];
  const date = G?.date||'-';
  document.getElementById('nhDateLabel').textContent = date+' ê¸°ì¤€';

  let data, title;
  if(_nhMode==='h') {
    data = stocks.filter(s=>s.nh_flag&&s.nh_flag!=='').sort((a,b)=>(b.nh_ratio||0)-(a.nh_ratio||0));
    title = '52ì£¼ ì‹ ê³ ê°€ ê·¼ì ‘ ì¢…ëª©';
  } else {
    // 52ì£¼ ì €ê°€ ê·¼ì ‘ (í˜„ì¬ê°€ê°€ 52ì£¼ ì €ê°€ì˜ 105% ì´ë‚´)
    data = stocks.filter(s=>s.low52>0&&s.price/s.low52*100<=110).sort((a,b)=>{
      const ra=a.price/a.low52*100, rb=b.price/b.low52*100;
      return ra-rb;
    });
    title = '52ì£¼ ì‹ ì €ê°€ ê·¼ì ‘ ì¢…ëª©';
  }
  document.getElementById('nhCardT').textContent = `${title} (${data.length}ê°œ)`;

  document.getElementById('nhList').innerHTML = data.length
    ? data.map((s,i)=>{
        const up=s.change>=0, pc=phaseColor(s.phase_key);
        const ratioLabel = _nhMode==='h'
          ? `ê³ ê°€ ëŒ€ë¹„ ${s.nh_ratio||0}%`
          : `ì €ê°€ ëŒ€ë¹„ ${(s.price/s.low52*100).toFixed(1)}%`;
        return `<div class="list-item" onclick="openStockModal('${s.code}')">
          <div class="li-no">${i+1}</div>
          <div class="li-info">
            <div class="li-name">${s.name} ${mktBadge(s.market)}</div>
            <div class="li-sub">
              ${s.nh_flag?`<span class="badge" style="color:#F97316;background:#F9731618">${s.nh_flag}</span>`:''}
              ${s.phase?`<span class="badge" style="color:${pc};background:${pc}18">${s.phase}</span>`:''}
              <span class="t3">${ratioLabel}</span>
            </div>
          </div>
          <div class="li-r">
            <div class="li-price ${up?'up':'dn'}">${fmtN(s.price)}</div>
            <div class="li-chg ${up?'up':'dn'}">${fmtP(s.change)}</div>
          </div>
        </div>`;
      }).join('')
    : `<div class="empty">í•´ë‹¹ ì¢…ëª© ì—†ìŒ<br><span class="t3 fs10">${date} ê¸°ì¤€ ê´€ì‹¬ì¢…ëª© ì¤‘</span></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 4: Phase
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const P_CHIPS=[{k:'all',l:'ì „ì²´'},{k:'golden',l:'â­ GOLDEN'},{k:'p2',l:'ğŸŸ¢ P2'},{k:'p1',l:'ğŸ”µ P1 ë§¤ì§‘'},{k:'p3',l:'ğŸ”´ P3 ê²½ê³ '}];

function renderTab4() {
  const stocks=G?.stocks||[], ps=G?.phase_stats||{}, date=G?.date||'-';
  document.getElementById('phaseDateLabel').textContent=date+' ê¸°ì¤€';

  document.getElementById('phaseStatGrid').innerHTML=[
    {l:'â­ GOLDEN',v:ps.golden||0,c:'#F5A623'},
    {l:'ğŸŸ¢ P2 ìƒìŠ¹',v:ps.p2||0,c:'#10D98A'},
    {l:'ğŸ”µ P1 ë§¤ì§‘',v:ps.p1||0,c:'#3B7BF6'},
    {l:'ğŸ”´ P3 ê²½ê³ ',v:ps.p3||0,c:'#FF4D6D'},
  ].map(s=>`<div class="stat-c" style="border-color:${s.c}22">
    <div class="stat-l">${s.l}</div>
    <div class="stat-v" style="color:${s.c}">${s.v}</div>
    <div class="stat-s">ì¢…ëª© (${date})</div>
  </div>`).join('');

  document.getElementById('pChips').innerHTML=P_CHIPS.map(c=>
    `<button class="p-chip ${c.k===_pFilter?'on':''}" onclick="setPF('${c.k}')">${c.l}</button>`
  ).join('');

  const filtered=_pFilter==='all'?stocks.filter(s=>s.phase):stocks.filter(s=>s.phase_key===_pFilter);
  document.getElementById('phaseCardT').textContent=
    (_pFilter==='all'?'ì „ì²´ Phase ì‹ í˜¸':(P_CHIPS.find(c=>c.k===_pFilter)?.l||''))+` (${filtered.length}ê°œ)`;

  document.getElementById('phaseList').innerHTML=filtered.length
    ? filtered.map((s,i)=>{
        const up=s.change>=0, pc=phaseColor(s.phase_key);
        return `<div class="list-item" onclick="openStockModal('${s.code}')">
          <div class="li-no">${i+1}</div>
          <div class="li-info">
            <div class="li-name">${s.name} ${mktBadge(s.market)}</div>
            <div class="li-sub">
              <span class="badge" style="color:${pc};background:${pc}18">${s.phase}</span>
              <span class="t3">ì™¸ì¸ì—°ì† ${s.f_consec||0}ì¼ Â· ê±°ë˜ëŸ‰${(s.vol_ratio||1).toFixed(1)}x</span>
            </div>
          </div>
          <div class="li-r">
            <div class="li-price ${up?'up':'dn'}">${fmtN(s.price)}</div>
            <div class="li-chg ${up?'up':'dn'}">${fmtP(s.change)}</div>
          </div>
        </div>`;
      }).join('')
    : `<div class="empty">í•´ë‹¹ ì‹ í˜¸ ì—†ìŒ<br><span class="t3 fs10">${date} ê¸°ì¤€</span></div>`;
}

function setPF(k) { _pFilter=k; renderTab4(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª¨ë‹¬: ì§€ìˆ˜ ìƒì„¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openIdxModal(name) {
  const idx = (G?.indices||[]).find(i=>i.name===name);
  if(!idx) return;
  const ms = G?.market_supply?.by_market||{};
  const up=idx.change>=0;
  document.getElementById('idxModalTitle').textContent=`${name} ìƒì„¸`;
  document.getElementById('idxModalSub').textContent=`${G?.date||'-'} ê¸°ì¤€ | ê±°ë˜ëŒ€ê¸ˆ: ${idx.vol}`;

  // í•´ë‹¹ ì‹œì¥ì˜ ìˆ˜ê¸‰ ë°ì´í„°
  const mktKey = name==='KOSPI'?'kospi':name==='KOSDAQ'?'kosdaq':null;
  const mktMs = mktKey?ms[mktKey]:null;

  let supHtml='<div class="empty">ìˆ˜ê¸‰ ë°ì´í„° ì—†ìŒ</div>';
  if(mktMs) {
    const rows=[
      {nm:'ì™¸êµ­ì¸',v:mktMs.foreign_net||0},
      {nm:'ê¸°ê´€',  v:mktMs.inst_net||0},
      {nm:'ê°œì¸',  v:mktMs.indiv_net||0},
    ];
    const maxA=Math.max(...rows.map(r=>Math.abs(r.v)),1);
    supHtml=rows.map(r=>{
      const ru=r.v>=0, pct=Math.abs(r.v)/maxA*100;
      return `<div class="sup-row">
        <div class="sup-nm">${r.nm}</div>
        <div class="sup-bw"><div class="sup-bf ${ru?'up':'dn'}" style="width:${pct}%"></div></div>
        <div class="sup-val ${ru?'up':'dn'}">${fmtAmt(r.v)}</div>
      </div>`;
    }).join('');
  }

  // ê´€ë ¨ ì¢…ëª© (í•´ë‹¹ ì‹œì¥ ê±°ë˜ëŒ€ê¸ˆ ìƒìœ„)
  const relStocks=(G?.stocks||[])
    .filter(s=>name==='KSP200'?true:s.market===name)
    .sort((a,b)=>(b.tr_val||0)-(a.tr_val||0)).slice(0,5);

  document.getElementById('idxModalBody').innerHTML=`
    <div class="modal-section">
      <div class="modal-section-t">ì§€ìˆ˜ í˜„í™©</div>
      <div style="display:flex;align-items:center;gap:12px;padding:8px 0">
        <div style="font-size:28px;font-weight:700;font-family:var(--mono);color:var(--${up?'up':'dn'})">${fmtN(idx.value)}</div>
        <div>
          <div style="font-family:var(--mono);font-size:13px;color:var(--${up?'up':'dn'})">${fmtP(idx.change)}</div>
          <div style="font-size:10px;color:var(--t3)">${up?'+':''}${fmtN(idx.diff)} pt</div>
        </div>
      </div>
    </div>
    <div class="modal-section">
      <div class="modal-section-t">íˆ¬ììë³„ ìˆ˜ê¸‰ (ë‹¹ì¼)</div>
      ${supHtml}
    </div>
    <div class="modal-section">
      <div class="modal-section-t">ê±°ë˜ëŒ€ê¸ˆ ìƒìœ„ ì¢…ëª© (${name})</div>
      ${relStocks.map((s,i)=>{
        const su=s.change>=0;
        return `<div class="list-item" onclick="openStockModal('${s.code}')">
          <div class="li-no">${i+1}</div>
          <div class="li-info">
            <div class="li-name">${s.name}</div>
            <div class="li-sub t3">${s.sector||''}</div>
          </div>
          <div class="li-r">
            <div class="li-price ${su?'up':'dn'}">${fmtN(s.price)}</div>
            <div class="li-chg ${su?'up':'dn'}">${fmtP(s.change)}</div>
          </div>
        </div>`;
      }).join('')}
    </div>`;
  document.getElementById('idxModal').classList.remove('hidden');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª¨ë‹¬: ì¢…ëª© ìƒì„¸ (Phase ìƒì„¸ í¬í•¨)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openStockModal(code) {
  const s = (G?.stocks||[]).find(s=>s.code===code);
  if(!s) return;
  const up=s.change>=0, pc=phaseColor(s.phase_key);
  const date=G?.date||'-';

  document.getElementById('stkModalTitle').textContent=s.name;
  document.getElementById('stkModalSub').textContent=
    `${s.market} Â· ${s.sector||'-'} Â· ${date} ê¸°ì¤€`;

  // ìˆ˜ê¸‰ ê¸°ê°„ë³„
  const sp=s.supply_periods||{};
  function spRow(label, key) {
    const d=sp[key]||{};
    return `<div style="padding:7px 0;border-bottom:1px solid var(--bd)">
      <div style="font-size:10px;color:var(--t3);margin-bottom:4px">${label}</div>
      <div style="display:flex;gap:8px;font-family:var(--mono);font-size:11px">
        <span>ì™¸ì¸ <strong class="${(d.foreign||0)>=0?'up':'dn'}">${fmtAmt(d.foreign||0)}</strong></span>
        <span>ê¸°ê´€ <strong class="${(d.inst||0)>=0?'up':'dn'}">${fmtAmt(d.inst||0)}</strong></span>
        <span>ê°œì¸ <strong class="${(d.indiv||0)>=0?'up':'dn'}">${fmtAmt(d.indiv||0)}</strong></span>
      </div>
    </div>`;
  }

  // Phase ë©”íŠ¸ë¦­
  const phaseHtml = s.phase ? `
    <div class="modal-section">
      <div class="modal-section-t">ğŸ“¡ Phase ì‹ í˜¸ ë¶„ì„</div>
      <div style="display:inline-block;padding:5px 12px;border-radius:99px;font-size:12px;font-weight:700;color:${pc};background:${pc}18;border:1px solid ${pc}35;margin-bottom:10px">${s.phase}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        ${[
          {l:'ë¬´ê²Œìˆ˜ ë¹„ìœ¨',v:(s.muges_ratio||1).toFixed(2),desc:s.muges_ratio<0.7?'ë§¤ì§‘ì¤‘(ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ)':s.muges_ratio>2?'ë¶„ì‚°ìœ„í—˜':'ë³´í†µ'},
          {l:'SMP',v:(s.smp>=0?'+':'')+s.smp+'%',desc:s.smp>0?'ê¸°ê´€+ì™¸ì¸ ìˆœë§¤ìˆ˜':'ìˆœë§¤ë„'},
          {l:'ê±°ë˜ëŸ‰ ë°°ìˆ˜',v:(s.vol_ratio||1).toFixed(1)+'x',desc:s.vol_ratio>=2?'ê±°ë˜ í­ë°œ':'ë³´í†µ'},
          {l:'ì™¸ì¸ ì—°ì†',v:(s.f_consec||0)+'ì¼',desc:s.f_consec>=5?'ê°•í•œ ë§¤ì§‘':s.f_consec>=3?'ë§¤ì§‘ ì§„í–‰':''},
          {l:'ê¸°ê´€ ì—°ì†',v:(s.i_consec||0)+'ì¼',desc:''},
          {l:'OBV',v:s.obv_above_ma?'MA ìƒí–¥ëŒíŒŒ':'MA í•˜í–¥',desc:''},
        ].map(m=>`<div style="background:rgba(255,255,255,.04);border-radius:var(--r8);padding:8px 10px">
          <div style="font-size:9.5px;color:var(--t3);margin-bottom:3px">${m.l}</div>
          <div style="font-family:var(--mono);font-size:13px;font-weight:600;color:var(--t1)">${m.v}</div>
          ${m.desc?`<div style="font-size:9px;color:var(--t2);margin-top:2px">${m.desc}</div>`:''}
        </div>`).join('')}
      </div>
    </div>` : '';

  document.getElementById('stkModalBody').innerHTML=`
    <div class="modal-section">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 0 10px">
        <div>
          <div style="font-size:26px;font-weight:700;font-family:var(--mono);color:var(--${up?'up':'dn'})">${fmtN(s.price)}</div>
          <div style="font-family:var(--mono);font-size:12px;color:var(--${up?'up':'dn'})">${fmtP(s.change)} (${up?'+':''}${fmtN(s.diff)})</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:10px;color:var(--t3)">52ì£¼ ê³ ê°€</div>
          <div style="font-family:var(--mono);font-size:12px">${fmtN(s.high52)}</div>
          <div style="font-size:9px;color:var(--t3);margin-top:4px">ê³ ê°€ ëŒ€ë¹„</div>
          <div style="font-family:var(--mono);font-size:12px;color:${s.nh_ratio>=99?'var(--go)':'var(--t2)'}">${s.nh_ratio||0}%</div>
        </div>
      </div>
      ${s.nh_flag?`<div style="display:inline-block;padding:3px 10px;border-radius:99px;font-size:11px;font-weight:700;color:#F97316;background:#F9731618;border:1px solid #F9731630;margin-bottom:6px">${s.nh_flag}</div>`:''}
    </div>
    ${phaseHtml}
    <div class="modal-section">
      <div class="modal-section-t">íˆ¬ììë³„ ìˆ˜ê¸‰</div>
      ${spRow('ì˜¤ëŠ˜','day')}
      ${spRow('1ì£¼ì¼','week')}
      ${spRow('1ê°œì›”','month')}
    </div>
    <div class="modal-section">
      <div class="modal-section-t">ì¢…ëª© ì •ë³´</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px">
        <div class="t3">ì‹œì¥</div><div style="text-align:right">${mktBadge(s.market)}</div>
        <div class="t3">ì—…ì¢…</div><div style="text-align:right">${s.sector||'-'}</div>
        <div class="t3">ì‹œê°€ì´ì•¡</div><div style="text-align:right;font-family:var(--mono)">${fmtAmt(s.mktcap*1e8||0)}</div>
        <div class="t3">ê±°ë˜ëŸ‰</div><div style="text-align:right;font-family:var(--mono)">${fmtN(s.volume)}</div>
        <div class="t3">ê±°ë˜ëŒ€ê¸ˆ</div><div style="text-align:right;font-family:var(--mono)">${fmtAmt(s.tr_val||0)}</div>
        <div class="t3">52ì£¼ ì €ê°€</div><div style="text-align:right;font-family:var(--mono)">${fmtN(s.low52)}</div>
      </div>
    </div>`;
  document.getElementById('stockModal').classList.remove('hidden');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª¨ë‹¬: ì„¹í„° ìƒì„¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openSecModal(idx) {
  const sectors = groupBySector(G?.stocks||[]);
  const sec = sectors[idx];
  if(!sec) return;
  const date=G?.date||'-';
  const up=sec.avgChange>=0;

  document.getElementById('secModalTitle').textContent=`${sec.name} ì„¹í„°`;
  document.getElementById('secModalSub').textContent=`${date} ê¸°ì¤€ Â· í‰ê·  ${sec.avgChange>=0?'+':''}${sec.avgChange.toFixed(2)}% Â· ì´ ê±°ë˜ëŒ€ê¸ˆ ${fmtAmt(sec.totalTrVal)}`;

  document.getElementById('secModalBody').innerHTML=`
    <div class="modal-section">
      <div class="modal-section-t">ê±°ë˜ëŒ€ê¸ˆ ìƒìœ„ ì¢…ëª© (${date})</div>
      ${sec.stocks.slice(0,10).map((s,i)=>{
        const su=s.change>=0;
        return `<div class="list-item" onclick="closeModalDirect('secModal');openStockModal('${s.code}')">
          <div class="li-no">${i+1}</div>
          <div class="li-info">
            <div class="li-name">${s.name} ${mktBadge(s.market)}</div>
            <div class="li-sub t3">ê±°ë˜ëŒ€ê¸ˆ ${fmtAmt(s.tr_val||0)}</div>
          </div>
          <div class="li-r">
            <div class="li-price ${su?'up':'dn'}">${fmtN(s.price)}</div>
            <div class="li-chg ${su?'up':'dn'}">${fmtP(s.change)}</div>
          </div>
        </div>`;
      }).join('')}
    </div>`;
  document.getElementById('secModal').classList.remove('hidden');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª¨ë‹¬ ê³µí†µ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function closeModal(id, e) {
  if(e?.target === document.getElementById(id))
    document.getElementById(id).classList.add('hidden');
}
function closeModalDirect(id) {
  document.getElementById(id).classList.add('hidden');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   íƒ­ ì „í™˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(idx) {
  document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('on', b.dataset.t===idx));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('on', b.dataset.n===idx));
  document.querySelectorAll('.panel').forEach(p=>{
    const on = p.dataset.p===idx;
    p.classList.toggle('on', on);
    if(on) p.classList.add('fu');
  });
  document.getElementById('mainEl').scrollTop=0;
}
document.querySelectorAll('.tab').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.t)));
document.querySelectorAll('.nav-btn').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.n)));
document.querySelectorAll('[data-goto]').forEach(el=>el.addEventListener('click',()=>switchTab(el.dataset.goto)));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë”ë³´ê¸°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleMore(id) {
  const el=document.getElementById(id);
  const open=el.classList.toggle('open');
  el.previousElementSibling.textContent=open?'â–´ ì ‘ê¸°':'â–¾ ë”ë³´ê¸°';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í‹°ì»¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTicker() {
  const items=[
    ...(G?.indices||[]).map(i=>({n:i.name,v:fmtN(i.value),c:i.change,up:i.change>=0})),
    ...(G?.stocks||[]).slice(0,15).map(s=>({n:s.name,v:fmtN(s.price),c:s.change,up:s.change>=0})),
  ];
  const html=items.concat(items).map(t=>
    `<div class="tk"><span class="tk-n">${t.n}</span>&nbsp;<span class="${t.up?'up':'dn'}">${t.v} ${fmtP(t.c)}</span></div>`
  ).join('');
  document.getElementById('tickerEl').innerHTML=html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì‹œê³„ & ì¥ì¤‘ ìƒíƒœ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateClock() {
  const kst=new Date(Date.now()+9*3600000);
  const hh=String(kst.getUTCHours()).padStart(2,'0');
  const mm=String(kst.getUTCMinutes()).padStart(2,'0');
  const ss=String(kst.getUTCSeconds()).padStart(2,'0');
  document.getElementById('clockEl').textContent=`${hh}:${mm}:${ss}`;
  const t=kst.getUTCHours()*60+kst.getUTCMinutes();
  const open=t>=545&&t<=930&&kst.getUTCDay()>0&&kst.getUTCDay()<6;
  const dot=document.getElementById('liveDot'), lbl=document.getElementById('liveLabel');
  const pill=document.getElementById('livePill');
  if(open){
    dot.style.cssText='background:var(--up);animation:pulse 1.8s infinite';
    lbl.textContent='LIVE'; lbl.style.color='var(--up)';
    pill.style.cssText='background:rgba(16,217,138,.1);border-color:rgba(16,217,138,.25)';
  } else {
    dot.style.cssText='background:var(--fl)';
    lbl.textContent='ë§ˆê°'; lbl.style.color='var(--fl)';
    pill.style.cssText='background:rgba(107,122,153,.1);border-color:rgba(107,122,153,.2)';
  }
}
setInterval(updateClock,1000); updateClock();

// ì¥ì¤‘ ìë™ ìƒˆë¡œê³ ì¹¨ (5ë¶„)
setInterval(()=>{
  const kst=new Date(Date.now()+9*3600000);
  const t=kst.getUTCHours()*60+kst.getUTCMinutes();
  if(t>=545&&t<=935&&kst.getUTCDay()>0&&kst.getUTCDay()<6) loadData();
},5*60*1000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì‹œì‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
loadData();
</script>
</body>
</html>
