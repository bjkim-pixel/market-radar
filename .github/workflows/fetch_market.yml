name: π“ μ‹μ¥ λ°μ΄ν„° μμ§‘

on:
  schedule:
    # μ¥μ¤‘: ν‰μΌ 09:05 ~ 15:35 (KST = UTC+9, 5λ¶„ κ°„κ²©)
    - cron: '5,10,15,20,25,30,35,40,45,50,55 0 * * 1-5'   # 09:05~09:55
    - cron: '0,5,10,15,20,25,30,35,40,45,50,55 1 * * 1-5'  # 10:00~10:55
    - cron: '0,5,10,15,20,25,30,35,40,45,50,55 2 * * 1-5'  # 11:00~11:55
    - cron: '0,5,10,15,20,25,30,35,40,45,50,55 3 * * 1-5'  # 12:00~12:55
    - cron: '0,5,10,15,20,25,30,35,40,45,50,55 4 * * 1-5'  # 13:00~13:55
    - cron: '0,5,10,15,20,25,30,35,40,45,50,55 5 * * 1-5'  # 14:00~14:55
    - cron: '0,5,10,15,20,25,30,35 6 * * 1-5'              # 15:00~15:35
    # μ¥λ§κ° ν›„ Phase μ‹ νΈ κ³„μ‚° (15:40 KST)
    - cron: '40 6 * * 1-5'
  workflow_dispatch: # μλ™ μ‹¤ν–‰ λ²„νΌ

jobs:
  collect:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # data/ ν΄λ”μ— JSON μ»¤λ°‹ κ¶ν•

    steps:
      - name: π“¥ μ €μ¥μ† μ²΄ν¬μ•„μ›ƒ
        uses: actions/checkout@v4

      - name: π Python μ„Έν…
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: π“¦ ν¨ν‚¤μ§€ μ„¤μΉ
        run: pip install requests pandas numpy

      - name: π“΅ λ°μ΄ν„° μμ§‘ & μ‹ νΈ κ³„μ‚°
        env:
          KIS_APP_KEY:    ${{ secrets.KIS_APP_KEY }}
          KIS_APP_SECRET: ${{ secrets.KIS_APP_SECRET }}
          KIS_ACCOUNT_NO: ${{ secrets.KIS_ACCOUNT_NO }}
        run: python scripts/fetch_market.py

      - name: π’Ύ JSON λ°μ΄ν„° μ»¤λ°‹
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git diff --staged --quiet || git commit -m "π“ μ‹μ¥ λ°μ΄ν„° μ—…λ°μ΄νΈ $(date +'%Y-%m-%d %H:%M KST' -d '+9 hours')"
          git push

